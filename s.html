<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VSCO Newest Search</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input { padding: 10px 12px; font-size: 16px; width: min(520px, 100%); }
    button { padding: 10px 12px; font-size: 16px; cursor: pointer; }
    .muted { color: #555; font-size: 14px; }
    .grid { margin-top: 18px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; background: #fff; }
    .card img { width: 100%; height: 220px; object-fit: cover; display: block; background: #f3f3f3; }
    .meta { padding: 10px; display: grid; gap: 6px; }
    .meta a { text-decoration: none; color: #0b5; }
    .meta small { color: #666; }
    .error { margin-top: 12px; padding: 12px; background: #ffecec; border: 1px solid #ffb3b3; border-radius: 10px; color: #900; }
    .bar { margin-top: 14px; display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>VSCO Search (Newest First)</h1>

  <div class="row">
    <input id="q" placeholder="keyword (e.g., dogs)" />
    <button id="searchBtn">Search</button>
    <button id="loadMoreBtn" disabled>Load more</button>
  </div>

  <div class="bar">
    <label class="muted">
      Pages per fetch:
      <select id="pages">
        <option>1</option>
        <option selected>2</option>
        <option>3</option>
        <option>5</option>
      </select>
    </label>
    <label class="muted">
      Items per page:
      <select id="size">
        <option>20</option>
        <option>50</option>
        <option selected>100</option>
      </select>
    </label>
    <span class="muted" id="status"></span>
  </div>

  <div id="err" class="error" style="display:none"></div>
  <div id="grid" class="grid"></div>

<script>
  const $q = document.getElementById('q');
  const $searchBtn = document.getElementById('searchBtn');
  const $loadMoreBtn = document.getElementById('loadMoreBtn');
  const $grid = document.getElementById('grid');
  const $status = document.getElementById('status');
  const $err = document.getElementById('err');
  const $pages = document.getElementById('pages');
  const $size = document.getElementById('size');

  let currentQuery = "";
  let nextPage = 1;
  let allResults = [];

  function showError(msg) {
    $err.textContent = msg;
    $err.style.display = "block";
  }
  function clearError() {
    $err.style.display = "none";
    $err.textContent = "";
  }

  function pickImageUrl(item) {
    // VSCO sometimes uses different fields. Try a few.
    return item.responsive_url || item.image_url || item.url || (item.media && item.media.url) || "";
  }

  function pickPermalink(item) {
    return item.permalink || item.link || "";
  }

  function pickUser(item) {
    return (item.user && (item.user.username || item.user.name)) || item.username || "unknown";
  }

  function pickDate(item) {
    return item.upload_date || item.created_at || item.published_at || "";
  }

  function render(results) {
    $grid.innerHTML = results.map(item => {
      const img = pickImageUrl(item);
      const link = pickPermalink(item);
      const user = pickUser(item);
      const date = pickDate(item);
      const safeLink = link ? link : "#";
      return `
        <div class="card">
          <a href="${safeLink}" target="_blank" rel="noopener">
            <img loading="lazy" src="${img}" alt="">
          </a>
          <div class="meta">
            <div><strong>${escapeHtml(user)}</strong></div>
            <small>${escapeHtml(date)}</small>
            <a href="${safeLink}" target="_blank" rel="noopener">Open</a>
          </div>
        </div>
      `;
    }).join("");
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

 async function fetchPage(query, page, size) {
  const WORKER_BASE = "https://snowy-flower-a769.kol902100.workers.dev"; // <- change this
  const url = `${WORKER_BASE}/api/search?query=${encodeURIComponent(query)}&page=${page}&size=${size}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status} from proxy`);
  return res.json();
  }

  async function doSearch(reset) {
    clearError();

    const query = $q.value.trim();
    if (!query) return;

    const size = Number($size.value);
    const pagesToFetch = Number($pages.value);

    if (reset) {
      currentQuery = query;
      nextPage = 1;
      allResults = [];
      $grid.innerHTML = "";
      $loadMoreBtn.disabled = true;
    }

    $searchBtn.disabled = true;
    $loadMoreBtn.disabled = true;
    $status.textContent = "Loading…";

    try {
      // Fetch multiple pages then sort by newest
      const fetched = [];
      for (let i = 0; i < pagesToFetch; i++) {
        const page = nextPage + i;
        const json = await fetchPage(currentQuery, page, size);
        const items = json.results || json.items || [];
        fetched.push(...items);
        if (items.length === 0) break;
      }

      nextPage += pagesToFetch;

      allResults.push(...fetched);

      // Sort newest first
      allResults.sort((a, b) => new Date(pickDate(b)) - new Date(pickDate(a)));

      render(allResults);

      $status.textContent = `${allResults.length} results (sorted newest → oldest).`;
      $loadMoreBtn.disabled = allResults.length === 0;
    } catch (e) {
      showError(
        `Error: ${e.message}\n\n` +
        `If you see a CORS error in the console, use the Cloudflare Worker proxy option below.`
      );
      $status.textContent = "";
    } finally {
      $searchBtn.disabled = false;
    }
  }

  $searchBtn.addEventListener('click', () => doSearch(true));
  $loadMoreBtn.addEventListener('click', () => doSearch(false));
  $q.addEventListener('keydown', (e) => { if (e.key === "Enter") doSearch(true); });
</script>
</body>
</html>
