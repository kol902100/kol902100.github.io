<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Tellonym Answer Fetcher</title>

<style>
body{
  font-family:system-ui;
  margin:16px;
}

input{
  padding:6px;
  margin:4px 0;
}

button{
  padding:8px 12px;
  margin-right:8px;
}

label{
  display:inline-block;
  margin-top:6px;
}

table{
  border-collapse:collapse;
  width:100%;
  margin-top:12px;
}

th,td{
  border:1px solid #ddd;
  padding:6px;
  vertical-align:top;
}

th{
  background:#f0f0f0;
}

a{
  color:blue;
}

.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  object-fit:cover;
  display:block;
}

#status{
  margin-top:10px;
  font-weight:600;
}

small{
  color:#666;
}
</style>

</head>
<body>

<h2>Tellonym Answer Fetcher</h2>

<label>Starting Answer ID</label><br>
<input id="startId" placeholder="e.g. 6839604116"><br>

<label>Number to collect</label><br>
<input id="want" value="50"><br>

<label>Delay between batches (ms)</label><br>
<input id="delay" value="800"><br>

<label style="display:block;margin-top:10px;">
  <input id="excludeArabic" type="checkbox">
  Exclude Arabic characters (filter Tell + Answer after loading)
</label>
<small>When enabled, any row containing Arabic script in Tell or Answer will be hidden.</small>

<br><br>

<button onclick="start()">Start</button>
<button onclick="stop()">Stop</button>
<button onclick="exportCSV()">Export CSV</button>

<div id="status"></div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Avatar</th>
<th>Respondent Username</th>
<th>Respondent Profile</th>
<th>Created</th>
<th>Tell</th>
<th>Answer</th>
</tr>
</thead>

<tbody id="results"></tbody>
</table>

<script>
const WORKER = "https://blue-morning-f3e9.kol902100.workers.dev";
const USERNAME = "AAA"; // required by the endpoint you provided

const BATCH_SIZE = 20;

let abort = false;
let results = []; // keep raw results for CSV and filtering

function sleep(ms){
  return new Promise(r=>setTimeout(r,ms));
}

function stop(){
  abort = true;
}

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function hasArabic(text){
  // Arabic blocks: 0600–06FF, 0750–077F, 08A0–08FF, FB50–FDFF, FE70–FEFF
  // (includes Arabic Presentation Forms)
  return /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(text || "");
}

function rowShouldHide(data){
  if(!document.getElementById("excludeArabic").checked) return false;
  const tell = data.tell || "";
  const answer = data.answer || "";
  return hasArabic(tell) || hasArabic(answer);
}

async function fetchAnswer(id){
  const target =
    `https://tellonym.me/api/answers/id/${id}?answerId=${id}&username=${encodeURIComponent(USERNAME)}&limit=24`;

  const url =
    `${WORKER}?target=${encodeURIComponent(target)}`;

  try{
    const res = await fetch(url);

    if(res.status === 404) return null;
    if(!res.ok) return null;

    const data = await res.json();
    if(!data || !data.id) return null;

    return data;
  }catch{
    return null;
  }
}

function avatarCandidates(user){
  const file =
    user?.avatarFileName ||
    user?.avatarFilename ||
    "";

  if(!file) return [];

  return [
    `https://userimg.tellonym.me/sm-v2/${file}`,
    `https://userimg.tellonym.me/lg-v2/${file}`,
  ];
}

function renderAllRows(){
  const tbody = document.getElementById("results");
  tbody.innerHTML = "";
  for(const data of results){
    if(rowShouldHide(data)) continue;
    tbody.appendChild(buildRow(data));
  }
}

function buildRow(data){
  const respondent = data.user?.username || "";
  const profileLink = respondent ? `https://tellonym.me/${respondent}` : "";

  const candidates = avatarCandidates(data.user);
  const avatarURL = candidates[0] || "";
  const fallbackURL = candidates[1] || "";

  const tr = document.createElement("tr");

  tr.innerHTML = `
<td>${data.id}</td>

<td>
  ${
    avatarURL
    ? `<a href="${profileLink || '#'}" target="_blank" rel="noopener">
         <img class="avatar"
              src="${avatarURL}"
              onerror="this.onerror=null; this.src='${fallbackURL}'"
              alt="">
       </a>`
    : ""
  }
</td>

<td>${escapeHTML(respondent)}</td>

<td>
  ${
    profileLink
    ? `<a href="${profileLink}" target="_blank" rel="noopener">${profileLink}</a>`
    : ""
  }
</td>

<td>${escapeHTML(data.createdAt || "")}</td>
<td>${escapeHTML(data.tell || "")}</td>
<td>${escapeHTML(data.answer || "")}</td>
`;

  return tr;
}

document.getElementById("excludeArabic").addEventListener("change", () => {
  // Filter once loaded (re-render without modifying the stored results)
  renderAllRows();
});

async function fetchBatch(startId){
  const ids = [];
  for(let i=0;i<BATCH_SIZE;i++){
    ids.push(startId + i);
  }

  // Fetch all 20 in parallel
  const promises = ids.map(id => fetchAnswer(id));
  const batch = await Promise.all(promises);

  // Keep only non-null responses
  return batch.filter(x => x);
}

async function start(){
  abort = false;
  results = [];
  document.getElementById("results").innerHTML = "";

  let id = Number(document.getElementById("startId").value);
  const want = Number(document.getElementById("want").value);
  const delay = Number(document.getElementById("delay").value);

  if(!Number.isFinite(id) || !Number.isFinite(want) || want <= 0){
    alert("Enter a valid Starting Answer ID and Number to collect.");
    return;
  }

  let collected = 0;
  let attempts = 0;

  while(!abort && collected < want){
    attempts += BATCH_SIZE;

    document.getElementById("status").innerText =
      `Attempts: ${attempts} | Collected: ${collected}/${want} | Next batch from ID: ${id}`;

    const batchResults = await fetchBatch(id);

    // Store all successful results
    for(const item of batchResults){
      if(collected >= want) break;

      results.push(item);

      // Render row only if it passes the current filter setting
      if(!rowShouldHide(item)){
        document.getElementById("results").appendChild(buildRow(item));
      }

      collected++;
    }

    id += BATCH_SIZE;

    await sleep(delay);
  }

  document.getElementById("status").innerText =
    abort ? "Stopped." : `Done. Collected ${results.length}.`;
}

function exportCSV(){
  if(results.length === 0){
    alert("No results yet.");
    return;
  }

  // Export respects the checkbox: if checked, excluded rows are NOT exported
  const excludeArabic = document.getElementById("excludeArabic").checked;

  let csv = "ID,RespondentUsername,RespondentProfile,AvatarURL,Created,Tell,Answer\n";

  for(const r of results){
    if(excludeArabic && (hasArabic(r.tell || "") || hasArabic(r.answer || ""))) continue;

    const respondent = r.user?.username || "";
    const profile = respondent ? `https://tellonym.me/${respondent}` : "";

    const cands = avatarCandidates(r.user);
    const avatarURL = cands[1] || cands[0] || "";

    const tell = String(r.tell ?? "").replaceAll('"','""');
    const answer = String(r.answer ?? "").replaceAll('"','""');
    const created = String(r.createdAt ?? "").replaceAll('"','""');

    csv += `${r.id},"${respondent.replaceAll('"','""')}","${profile}","${avatarURL}","${created}","${tell}","${answer}"\n`;
  }

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "tellonym_answers.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
